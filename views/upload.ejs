<%- include('partials/head.ejs', { title: 'Upload Game' }) %>
<%- include('partials/alert.ejs') %>
<%- include('partials/menu.ejs', {userName : user.userName}) %>


<script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<style>
    textarea {
        min-width: 500px;
        min-height: 300px;
    }
</style>



<div class="h4 text-center"> Complete requested fields and upload your own game ! </div>

<form id="send-game" method="post" enctype="multipart/form-data">
    <div class="form-group">
        <label>Game ID</label>
        <input type="text" class="form-control" name="gameID">
    </div>
    <div class="form-group">
        <label>Game title</label>
        <input type="text" class="form-control" name="gameTitle">
    </div>
    <div class="form-group">
        <label>Archive</label>
        <input name="gameArchive" class="form-control" type="file">
    </div>
    <div class="form-group">
            <label>Language</label>
            <div id="lan">
                    <%- include('partials/dropdown.ejs', {
                        defaultOption: 'cpp',
                        options: (function() {
                        const options = {};
                        for(var key in languages) {
                            options[key] = languages[key].name;
                        }
                        return options;
                        })()
                        }) %>
                </div> 
    </div>
    <center>
    <input class="btn btn-primary" id="upload" type="submit" value="Upload">
    </center>
</form>

<script src="/scripts/DropDown.js"></script>

<!-- Modal - displaying messages -->
<div class="modal fade" id="modal-message" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body">
                    <p></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


<script>
    $('#send-game').on('submit', e => {
        console.log('CHUJek');
        e.preventDefault();

        var data = new FormData();

        var archiveFile = $('#send-game :input[name="gameArchive"]')[0];
        data.append('archive', archiveFile.files[0]);
        
        var title = $('#send-game :input[name="gameTitle"]')[0];
        data.append('title', title.value);

        var ID = $('#send-game :input[name="gameID"]')[0];
        data.append('ID', ID.value );

        var language =  $(`#lan .dropdown`).data('value');
        data.append('language', language);

        console.log("LANGUAGE ", language);

        data.append('username', "<%= user.userName %>");

        fetch('/upload/upload-run', {
            method: 'post',
            body: data
        })  .then(response => response.json())
            .then(
                response => {
                    console.log(response);
                    if (response.err) {
                        $('#modal-message .modal-title').text("Error");
                        $('#modal-message .modal-body').text(response.err);
                        $('#modal-message').modal();
                    }
                    else {
                        console.log("SUCCES");
                        document.getElementById("send-game").reset();
                        $('#modal-message .modal-title').text("Success");
                        $('#modal-message .modal-body').text(
                            "Congratulations, game successfully uploaded");
                        $('#modal-message').modal();
                    }
                }
            )
            .catch(console.error);
    });

</script>


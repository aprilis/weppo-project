<%- include('partials/head.ejs', { title: 'Upload Game' }) %>
<%- include('partials/alert.ejs') %>
<%- include('partials/menu.ejs', {userName : user.userName}) %>


Complete requested fields and click submit to upload your new game ! 

<script src="/ace-builds/src-noconflict/ace.js" type="text/javascript" charset="utf-8"></script>

<style>
    textarea {
        min-width: 500px;
        min-height: 300px;
    }
    #upload-form {
        margin: 20px

    }
</style>

<div id="upload" class="tab-pane fade in">
        <form id="send-game" method="post" enctype="multipart/form-data">
                Game ID:
                <input type="text" name="gameID"><br>
                Game title:
                <input type="text" name="gameTitle"><br>
                <br>
                Game archive:<br>
                <input name="gameArchive" type="file"><br>
                <div id ="lan">
                        Language: 
                        <%- include('partials/dropdown.ejs', {
                            defaultOption: 'cpp',
                            options: (function() {
                                const options = {};
                                for(var key in languages) {
                                    options[key] = languages[key].name;
                                }
                                return options;
                            })()
                        }) %>
                </div> <br>
                <input id="upload" type="submit" value="Upload">
                
        </form>


</div>

<!-- Modal - displaying messages -->
<div class="modal fade" id="modal-message" role="dialog">
        <div class="modal-dialog">
            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body">
                    <p></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


<script>
    $('#send-game').on('submit', e => {
        console.log('CHUJek');
        e.preventDefault();

        var data = new FormData();

        var archiveFile = $('#send-game :input[name="gameArchive"]')[0];
        data.append('archive', archiveFile.files[0]);
        
        var title = $('#send-game :input[name="gameTitle"]')[0];
        data.append('title', title.value);

        var ID = $('#send-game :input[name="gameID"]')[0];
        data.append('ID', ID.value );

        var language =  $(`#lan .dropdown`).data('value');
        data.append('language', language);

        data.append('username', "<%= user.userName %>");

        fetch('/upload/upload-run', {
            method: 'post',
            body: data
        })  .then(response => response.json())
            .then(
                response => {
                    console.log(response);
                    if (response.err) {
                        $('#modal-message .modal-title').text("Error");
                        $('#modal-message .modal-body').text(response.err);
                        $('#modal-message').modal();
                    }
                    else {
                        console.log("SUCCES");
                        $('#modal-message .modal-title').text("Success");
                        $('#modal-message .modal-body').text(
                            "Congratulations, game successfully uploaded");
                        $('#modal-message').modal();
                    }
                }
            )
            .catch(console.error);
    });

</script>